This is a more sophisticated solution where no expansion is used but with_self/2 is defined to pass along the current context.

See:

https://swi-prolog.discourse.group/t/modules-design-for-multi-agent-modeling/557/11